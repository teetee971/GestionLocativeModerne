<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Homygo ‚Äì Console</title>
  <meta name="description" content="Homygo ‚Äì console modulaire (PWA, dashboard, modules locatifs)." />
  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkhvbXlnbyIsCiAgInNob3J0X25hbWUiOiAiSG9teWdvIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwYjBmMTQiLAogICJ0aGVtZV9jb2xvciI6ICIjMGIwZjE0IiwKICAiaWNvbnMiOiBbCiAgICB7ICJzcmMiOiAiL2ljb25zL2ljb24tMTkyLnBuZyIsICJzaXplcyI6ICIxOTJ4MTkyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIiB9LAogICAgeyAic3JjIjogIi9pY29ucy9pY29uLTUxMi5wbmciLCAic2l6ZXMiOiAiNTEyeDUxMiIsICJ0eXBlIjogImltYWdlL3BuZyIgfQogIF0KfQo=">
  <meta name="theme-color" content="#0b0f14">

  <style>
    :root{
      color-scheme:dark light;
      --bg:#0b0f14; --bg-2:#0f141b; --panel:#111826; --line:#1f2a37;
      --muted:#98a2b3; --text:#e6e8ea; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --pri:#4fd1c5; --pri-600:#0ea5a8; --accent:#60a5fa;
      --r:14px; --shadow: 0 10px 30px rgba(0,0,0,.35);
      --gap:14px; --pad:16px; --font: system-ui, -apple-system, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial;
      --container: 1200px;
      --chip:#0b1220; --chip-line:#162033;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font-family:var(--font);
      display:grid; grid-template-rows: 64px 1fr;
    }

    /* Topbar */
    header{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(6px);
      background:linear-gradient(180deg, rgba(15,20,27,.9), rgba(15,20,27,.7));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:var(--container); margin:auto; padding:0 var(--pad); height:64px;
      display:flex; align-items:center; gap:12px}
    .logo{display:flex; align-items:center; gap:10px; font-weight:700}
    .logo .dot{width:10px; height:10px; border-radius:50%; background:var(--pri)}
    .logo small{color:var(--muted); font-weight:500}
    .spacer{flex:1}

    /* App layout */
    main{max-width:var(--container); margin:24px auto; padding:0 var(--pad)}
    .grid{display:grid; gap:var(--gap); grid-template-columns: 220px 1fr}
    nav{
      position:sticky; top:84px; align-self:start; background:var(--bg-2);
      border:1px solid var(--line); border-radius:var(--r); padding:10px;
    }
    nav a{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px;
      color:var(--text); text-decoration:none; border:1px solid transparent;
    }
    nav a:hover{background:rgba(255,255,255,.03); border-color:var(--line)}
    nav a.active{background:#0f1b22; border-color:#14303b; color:#c3f0f0}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px;
      background:var(--chip); border:1px solid var(--chip-line); color:#cde7ff}
    .muted{color:var(--muted)}

    /* Toolbar */
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px}
    .toolbar h2{margin:0; font-size:20px; font-weight:700}
    .toolbar .btn{margin-left:auto}

    /* Buttons */
    .btn{
      border:1px solid var(--line); background:var(--panel); color:var(--text);
      padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:transform .06s ease, border-color .2s ease, background .2s ease;
    }
    .btn:hover{transform:translateY(-1px); border-color:#27455a}
    .btn.primary{background:var(--pri); color:#071316; border-color:#0b2f35}
    .btn.primary:hover{background:var(--pri-600)}
    .btn.ghost{background:transparent}

    /* Panels & cards */
    .panel{background:var(--bg-2); border:1px solid var(--line); border-radius:var(--r); padding:var(--pad); box-shadow:var(--shadow)}
    .cards{display:grid; gap:var(--gap); grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .card{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:12px}
    .kpi{font-weight:700; font-size:26px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}

    /* Table */
    .table{width:100%; border-collapse:separate; border-spacing:0 8px}
    .table th{font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); text-align:left; padding:6px 8px}
    .row{background:var(--panel); border:1px solid var(--line); border-radius:12px; overflow:hidden}
    .row td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.03)}
    .row td:last-child{border-bottom:none}
    .row .chip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#0e1520}

    /* Forms */
    .form{display:grid; gap:10px}
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .field input,.field select,.field textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0b121a; color:var(--text)
    }

    /* Search bar */
    .search{display:flex; gap:8px; margin:10px 0 16px}
    .search input{flex:1}

    /* Modal */
    dialog{
      border:none; border-radius:16px; width:min(560px,96%); background:var(--bg-2); color:var(--text);
      box-shadow:var(--shadow); padding:0;
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-header{display:flex; align-items:center; padding:14px 16px; border-bottom:1px solid var(--line)}
    .modal-body{padding:16px}
    .modal-actions{display:flex; gap:8px; justify-content:flex-end; padding:14px 16px; border-top:1px solid var(--line)}

    /* Responsive */
    @media (max-width:920px){
      .grid{grid-template-columns: 1fr}
      nav{position:static}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="logo"><span class="dot"></span> Homygo <small>Console</small></div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btn-refresh">‚Üª Actualiser</button>
      <button class="btn" id="btn-export">‚§ì Exporter CSV</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <nav id="menu">
        <a href="#/dashboard"><span>üìä</span> Tableau de bord</a>
        <a href="#/payments"><span>üí≥</span> Paiements <span class="badge" id="b-pay">0</span></a>
        <a href="#/tenants"><span>üë•</span> Locataires</a>
        <a href="#/properties"><span>üè†</span> Biens</a>
        <a href="#/tickets"><span>üõ†Ô∏è</span> Tickets</a>
        <a href="#/maintenance"><span>üîß</span> Maintenance</a>
        <a href="#/revenue"><span>üí∞</span> Revenus</a>
        <a href="#/settings"><span>‚öôÔ∏è</span> R√©glages</a>
      </nav>

      <section id="view" class="panel">
        <!-- contenu rendu ici -->
      </section>
    </div>
  </main>

  <!-- Modale g√©n√©rique -->
  <dialog id="modal">
    <div class="modal-header">
      <strong id="modal-title">Titre</strong>
      <div class="spacer"></div>
      <button class="btn ghost" onclick="Modal.close()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </dialog>

  <script>
  // ------------------------------------------------------------
  //    HOMYGO ‚Äì Console monofichier (modules + design)
  // ------------------------------------------------------------

  // PWA: enregistre le SW si pr√©sent
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(()=>{});
  }

  // ---------- Helpers UI ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);
  const fmtMoney = n => (Number(n)||0).toLocaleString('fr-FR', {style:'currency', currency:'EUR'});
  const fmtDate = d => new Date(d).toLocaleDateString('fr-FR');
  const uid = (p='id') => p+'_'+Math.random().toString(36).slice(2,9);
  const download = (name, content, type='text/csv')=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content],{type}));
    a.download = name; a.click(); URL.revokeObjectURL(a.href);
  };
  const csv = (rows) => rows.map(r=>Object.values(r).map(v => `"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');

  // ---------- Stockage ----------
  const KEY = 'HOMYGO_DB_V1';
  const DB = {
    _load(){
      try{ return JSON.parse(localStorage.getItem(KEY)) || this._seed(); }
      catch{ return this._seed(); }
    },
    _save(){ localStorage.setItem(KEY, JSON.stringify(this.state)); refreshBadges(); },
    _seed(){
      return {
        tenants: [
          {id:uid('t'), name:'Alice Martin', email:'alice@ex.com', phone:'06 11 22 33 44'},
          {id:uid('t'), name:'Brahim K.', email:'brahim@ex.com', phone:'06 55 22 66 77'},
          {id:uid('t'), name:'Chlo√© R.', email:'chloe@ex.com', phone:'06 33 99 11 22'},
        ],
        properties:[
          {id:uid('p'), ref:'A101', address:'12 rue Bellecour, Lyon', rent:920},
          {id:uid('p'), ref:'B204', address:'8 rue Moncey, Lyon', rent:780},
          {id:uid('p'), ref:'C330', address:'3 place Valmy, Lyon', rent:1050},
        ],
        payments:[
          {id:uid('pay'), tenant:'Alice Martin', property:'A101', amount:920, date:new Date(), status:'ok'},
          {id:uid('pay'), tenant:'Brahim K.', property:'B204', amount:0, date:new Date(), status:'req'},
        ],
        tickets:[
          {id:uid('tk'), title:'Fuite lavabo', priority:'haute', status:'ouvert', tenant:'Brahim K.', property:'B204', created:new Date()},
          {id:uid('tk'), title:'Peinture √©caill√©e', priority:'basse', status:'ouvert', tenant:'Chlo√© R.', property:'C330', created:new Date()},
        ],
        maintenance:[
          {id:uid('m'), place:'A101', type:'Plomberie', status:'urgent'},
          {id:uid('m'), place:'B204', type:'Peinture', status:'clos'},
        ],
        income:{ month:'Septembre', total: 2780, paid: 920, due: 1860 },
        settings:{ company:'Homygo', currency:'EUR' }
      };
    },
    state:null,
    init(){ this.state = this._load(); },
    save(){ this._save(); }
  };
  DB.init();

  function refreshBadges(){
    $('#b-pay').textContent = DB.state.payments.filter(p=>p.status!=='ok').length;
  }
  refreshBadges();

  // ---------- Modale ----------
  const Modal = {
    el: $('#modal'),
    open({title, body, actions=[]}){
      $('#modal-title').textContent = title || '';
      const bodyEl = $('#modal-body'); bodyEl.innerHTML=''; bodyEl.append(body instanceof Node ? body : html(body));
      const act = $('#modal-actions'); act.innerHTML='';
      actions.forEach(a=>{
        const b = document.createElement('button');
        b.className = 'btn'+(a.primary?' primary':''); b.textContent = a.label;
        b.onclick = ()=>a.onClick?.(this);
        act.append(b);
      });
      this.el.showModal();
    },
    close(){ this.el.close(); }
  };

  // Mini util pour fabriquer du DOM depuis une string
  function html(strings, ...vals){
    const raw = (typeof strings==='string') ? strings : strings.map((s,i)=> s + (vals[i]??'')).join('');
    const t = document.createElement('template'); t.innerHTML = raw.trim();
    return t.content.cloneNode(true);
  }

  // ---------- Toolbar ----------
  function setToolbar(title, buttons=[]){
    const c = document.createElement('div'); c.className='toolbar';
    c.append(html`<h2>${title}</h2>`);
    const spacer = document.createElement('div'); spacer.style.flex='1'; c.append(spacer);
    buttons.forEach(b=>{
      const btn = document.createElement('button');
      btn.className = 'btn'+(b.primary?' primary':'');
      btn.textContent = b.label;
      btn.onclick = b.onClick;
      c.append(btn);
    });
    return c;
  }

  // ---------- Export global ----------
  $('#btn-export').onclick = ()=>{
    const st = DB.state;
    const out = [
      '=== PAYMENTS ===',
      csv(st.payments),
      '\n=== TENANTS ===',
      csv(st.tenants),
      '\n=== PROPERTIES ===',
      csv(st.properties),
      '\n=== TICKETS ===',
      csv(st.tickets)
    ].join('\n');
    download(`homygo_export_${Date.now()}.csv`, out);
  };
  $('#btn-refresh').onclick = ()=> router();

  // ---------- Modules ----------
  const Modules = {
    dashboard(){
      const kpi = DB.state.income;
      const late = DB.state.payments.filter(p=>p.status!=='ok').reduce((a,b)=>a + (b.amount||0),0);
      const paid = DB.state.payments.filter(p=>p.status==='ok').reduce((a,b)=>a + (b.amount||0),0);
      const content = html`
        ${setToolbar('Tableau de bord', [
          {label:'Ajouter paiement', primary:true, onClick: ()=>Modules.payments.newPayment()},
          {label:'Nouveau ticket', onClick: ()=>Modules.tickets.newTicket()}
        ])}
        <div class="cards">
          <div class="card"><div class="muted">Mois</div><div class="kpi">${kpi.month}</div></div>
          <div class="card"><div class="muted">Total loyers</div><div class="kpi">${fmtMoney(kpi.total)}</div></div>
          <div class="card"><div class="muted">Pay√©</div><div class="kpi ok">${fmtMoney(paid)}</div></div>
          <div class="card"><div class="muted">En retard</div><div class="kpi warn">${fmtMoney(late)}</div></div>
        </div>
        <div class="panel" style="margin-top:16px">
          <div class="muted" style="margin-bottom:8px">Derniers tickets</div>
          <table class="table">
            <thead><tr>
              <th>Ticket</th><th>Locataire</th><th>Bien</th><th>Priorit√©</th><th>Statut</th><th>Cr√©√©</th>
            </tr></thead>
            <tbody>
              ${DB.state.tickets.slice(-5).reverse().map(t=>html`
                <tr class="row">
                  <td>${t.title}</td>
                  <td>${t.tenant}</td>
                  <td>${t.property}</td>
                  <td><span class="chip">${t.priority}</span></td>
                  <td><span class="chip">${t.status}</span></td>
                  <td>${fmtDate(t.created)}</td>
                </tr>
              `)}
            </tbody>
          </table>
        </div>
      `;
      setView(content);
    },

    // --- Paiements ---
    payments(){
      const view = document.createElement('div');
      view.append(setToolbar('Paiements', [
        {label:'Ajouter', primary:true, onClick: ()=>Modules.payments.newPayment()},
        {label:'Exporter CSV', onClick: ()=>download('paiements.csv', csv(DB.state.payments))}
      ]));

      // barre de recherche
      const search = html`
        <div class="search">
          <input id="q" class="field" placeholder="Rechercher (locataire, bien, statut)..." />
          <button class="btn" id="clear">Effacer</button>
        </div>
      `;
      view.append(search);

      const tableWrap = document.createElement('div'); view.append(tableWrap);

      function renderRows(filter=''){
        const rows = DB.state.payments
          .filter(p => [p.tenant,p.property,p.status,String(p.amount)].join(' ').toLowerCase().includes(filter.toLowerCase()))
          .map(p=>html`
            <tr class="row">
              <td>${p.tenant}</td>
              <td>${p.property}</td>
              <td>${fmtMoney(p.amount)}</td>
              <td>${fmtDate(p.date)}</td>
              <td><span class="chip ${p.status==='ok'?'ok':p.status==='req'?'warn':'err'}">${p.status}</span></td>
              <td style="text-align:right">
                <button class="btn" onclick="Modules.payments.markPaid('${p.id}')">Marquer pay√©</button>
                <button class="btn ghost" onclick="Modules.payments.del('${p.id}')">Suppr</button>
              </td>
            </tr>
          `);

        tableWrap.innerHTML='';
        tableWrap.append(html`
          <table class="table">
            <thead><tr>
              <th>Locataire</th><th>Bien</th><th>Montant</th><th>Date</th><th>Statut</th><th></th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `);
      }

      search.querySelector('#q').addEventListener('input', e=> renderRows(e.target.value));
      search.querySelector('#clear').onclick = ()=>{ search.querySelector('#q').value=''; renderRows(''); };

      renderRows('');
      setView(view);
    },
    newPayment(){
      const body = html`
        <form class="form" id="f">
          <div class="field"><label>Locataire</label>
            <select name="tenant">${DB.state.tenants.map(t=>`<option>${t.name}</option>`).join('')}</select></div>
          <div class="field"><label>Bien</label>
            <select name="property">${DB.state.properties.map(p=>`<option>${p.ref}</option>`).join('')}</select></div>
          <div class="field"><label>Montant (‚Ç¨)</label><input name="amount" type="number" min="0" required></div>
          <div class="field"><label>Date</label><input name="date" type="date" required></div>
          <div class="field"><label>Statut</label>
            <select name="status"><option value="ok">ok</option><option value="req">req</option><option value="impaye">impay√©</option></select></div>
        </form>`;
      Modal.open({
        title:'Nouveau paiement',
        body,
        actions:[
          {label:'Annuler', onClick:()=>Modal.close()},
          {label:'Enregistrer', primary:true, onClick:()=>{
            const f = body.querySelector('#f');
            const d = Object.fromEntries(new FormData(f).entries());
            DB.state.payments.push({id:uid('pay'), tenant:d.tenant, property:d.property, amount:+d.amount, date:new Date(d.date), status:d.status});
            DB.save(); Modal.close(); router();
          }}
        ]
      });
    },
    markPaid(id){
      const p = DB.state.payments.find(x=>x.id===id);
      if(!p) return;
      p.status='ok'; if(!p.amount||p.amount<1){ p.amount = DB.state.properties.find(b=>b.ref===p.property)?.rent || 0; }
      DB.save(); router();
    },
    del(id){
      DB.state.payments = DB.state.payments.filter(p=>p.id!==id);
      DB.save(); router();
    },

    // --- Locataires ---
    tenants(){
      const view = document.createElement('div');
      view.append(setToolbar('Locataires', [
        {label:'Ajouter', primary:true, onClick: ()=>Modules.tenants.add()},
        {label:'Exporter CSV', onClick: ()=>download('locataires.csv', csv(DB.state.tenants))}
      ]));

      const search = html`<div class="search"><input id="q" placeholder="Rechercher nom/email/t√©l√©phone‚Ä¶"></div>`;
      view.append(search);

      const tableWrap = document.createElement('div'); view.append(tableWrap);
      function renderRows(q=''){
        const rows = DB.state.tenants
          .filter(t => [t.name,t.email,t.phone].join(' ').toLowerCase().includes(q.toLowerCase()))
          .map(t=>html`
            <tr class="row">
              <td>${t.name}</td><td>${t.email}</td><td>${t.phone}</td>
              <td style="text-align:right">
                <button class="btn" onclick="Modules.tenants.edit('${t.id}')">√âditer</button>
                <button class="btn ghost" onclick="Modules.tenants.del('${t.id}')">Suppr</button>
              </td>
            </tr>
          `);
        tableWrap.innerHTML='';
        tableWrap.append(html`
          <table class="table">
            <thead><tr><th>Nom</th><th>Email</th><th>T√©l√©phone</th><th></th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        `);
      }
      search.querySelector('#q').addEventListener('input', e=>renderRows(e.target.value));
      renderRows('');
      setView(view);
    },
    add(){
      const body = html`
        <form class="form" id="f">
          <div class="field"><label>Nom</label><input name="name" required></div>
          <div class="field"><label>Email</label><input name="email" type="email"></div>
          <div class="field"><label>T√©l√©phone</label><input name="phone"></div>
        </form>`;
      Modal.open({title:'Nouveau locataire', body, actions:[
        {label:'Annuler', onClick:()=>Modal.close()},
        {label:'Enregistrer', primary:true, onClick:()=>{
          const d = Object.fromEntries(new FormData(body.querySelector('#f')).entries());
          DB.state.tenants.push({id:uid('t'), ...d}); DB.save(); Modal.close(); router();
        }}
      ]});
    },
    edit(id){
      const t = DB.state.tenants.find(x=>x.id===id); if(!t) return;
      const body = html`
        <form class="form" id="f">
          <div class="field"><label>Nom</label><input name="name" value="${t.name}" required></div>
          <div class="field"><label>Email</label><input name="email" type="email" value="${t.email}"></div>
          <div class="field"><label>T√©l√©phone</label><input name="phone" value="${t.phone}"></div>
        </form>`;
      Modal.open({title:'Modifier locataire', body, actions:[
        {label:'Fermer', onClick:()=>Modal.close()},
        {label:'Sauvegarder', primary:true, onClick:()=>{
          const d = Object.fromEntries(new FormData(body.querySelector('#f')).entries());
          Object.assign(t, d); DB.save(); Modal.close(); router();
        }}
      ]});
    },
    del(id){ DB.state.tenants = DB.state.tenants.filter(x=>x.id!==id); DB.save(); router(); },

    // --- Biens ---
    properties(){
      const v = document.createElement('div');
      v.append(setToolbar('Biens', [
        {label:'Ajouter', primary:true, onClick:()=>Modules.properties.add()},
        {label:'Exporter CSV', onClick:()=>download('biens.csv', csv(DB.state.properties))}
      ]));
      const rows = DB.state.properties.map(p=>html`
        <tr class="row">
          <td>${p.ref}</td><td>${p.address}</td><td>${fmtMoney(p.rent)}</td>
          <td style="text-align:right"><button class="btn" onclick="Modules.properties.edit('${p.id}')">√âditer</button>
          <button class="btn ghost" onclick="Modules.properties.del('${p.id}')">Suppr</button></td>
        </tr>
      `);
      v.append(html`
        <table class="table"><thead><tr><th>R√©f</th><th>Adresse</th><th>Loyer</th><th></th></tr></thead>
        <tbody>${rows}</tbody></table>
      `);
      setView(v);
    },
    add(){
      const body = html`
      <form class="form" id="f">
        <div class="field"><label>R√©f√©rence</label><input name="ref" required></div>
        <div class="field"><label>Adresse</label><input name="address" required></div>
        <div class="field"><label>Loyer (‚Ç¨)</label><input name="rent" type="number" value="0"></div>
      </form>`;
      Modal.open({title:'Nouveau bien', body, actions:[
        {label:'Annuler', onClick:()=>Modal.close()},
        {label:'Enregistrer', primary:true, onClick:()=>{
          const d = Object.fromEntries(new FormData(body.querySelector('#f')).entries());
          DB.state.properties.push({id:uid('p'), ref:d.ref, address:d.address, rent:+d.rent});
          DB.save(); Modal.close(); router();
        }}
      ]});
    },
    edit(id){
      const p = DB.state.properties.find(x=>x.id===id); if(!p) return;
      const body = html`
      <form class="form" id="f">
        <div class="field"><label>R√©f√©rence</label><input name="ref" value="${p.ref}" required></div>
        <div class="field"><label>Adresse</label><input name="address" value="${p.address}" required></div>
        <div class="field"><label>Loyer (‚Ç¨)</label><input name="rent" type="number" value="${p.rent}"></div>
      </form>`;
      Modal.open({title:'Modifier bien', body, actions:[
        {label:'Fermer', onClick:()=>Modal.close()},
        {label:'Sauvegarder', primary:true, onClick:()=>{
          const d = Object.fromEntries(new FormData(body.querySelector('#f')).entries());
          Object.assign(p, {ref:d.ref, address:d.address, rent:+d.rent}); DB.save(); Modal.close(); router();
        }}
      ]});
    },
    del(id){ DB.state.properties = DB.state.properties.filter(x=>x.id!==id); DB.save(); router(); },

    // --- Tickets ---
    tickets(){
      const v = document.createElement('div');
      v.append(setToolbar('Tickets', [
        {label:'Nouveau', primary:true, onClick:()=>Modules.tickets.newTicket()},
        {label:'Exporter CSV', onClick:()=>download('tickets.csv', csv(DB.state.tickets))}
      ]));

      const rows = DB.state.tickets.map(t=>html`
        <tr class="row">
          <td>${t.title}</td><td>${t.tenant}</td><td>${t.property}</td>
          <td><span class="chip">${t.priority}</span></td>
          <td><span class="chip">${t.status}</span></td>
          <td>${fmtDate(t.created)}</td>
          <td style="text-align:right">
            <button class="btn" onclick="Modules.tickets.close('${t.id}')">Clore</button>
            <button class="btn ghost" onclick="Modules.tickets.del('${t.id}')">Suppr</button>
          </td>
        </tr>
      `);
      v.append(html`
        <table class="table"><thead><tr>
          <th>Titre</th><th>Locataire</th><th>Bien</th><th>Priorit√©</th><th>Statut</th><th>Cr√©√©</th><th></th>
        </tr></thead><tbody>${rows}</tbody></table>
      `);
      setView(v);
    },
    newTicket(){
      const body = html`
      <form class="form" id="f">
        <div class="field"><label>Titre</label><input name="title" required></div>
        <div class="field"><label>Locataire</label>
          <select name="tenant">${DB.state.tenants.map(t=>`<option>${t.name}</option>`).join('')}</select></div>
        <div class="field"><label>Bien</label>
          <select name="property">${DB.state.properties.map(p=>`<option>${p.ref}</option>`).join('')}</select></div>
        <div class="field"><label>Priorit√©</label>
          <select name="priority"><option>basse</option><option>normale</option><option>haute</option></select></div>
      </form>`;
      Modal.open({title:'Nouveau ticket', body, actions:[
        {label:'Annuler', onClick:()=>Modal.close()},
        {label:'Cr√©er', primary:true, onClick:()=>{
          const d = Object.fromEntries(new FormData(body.querySelector('#f')).entries());
          DB.state.tickets.push({id:uid('tk'), ...d, status:'ouvert', created:new Date()});
          DB.save(); Modal.close(); router();
        }}
      ]});
    },
    close(id){ const t=DB.state.tickets.find(x=>x.id===id); if(t){ t.status='clos'; DB.save(); router(); } },
    del(id){ DB.state.tickets = DB.state.tickets.filter(x=>x.id!==id); DB.save(); router(); },

    // --- Maintenance ---
    maintenance(){
      const v = document.createElement('div');
      v.append(setToolbar('Maintenance', [
        {label:'Nouvel ordre', primary:true, onClick:()=>Modules.maintenance.newOrder()}
      ]));
      const rows = DB.state.maintenance.map(w=>html`
        <tr class="row">
          <td>${w.place}</td><td>${w.type}</td>
          <td><span class="chip ${w.status==='urgent'?'warn':w.status==='clos'?'ok':''}">${w.status}</span></td>
          <td style="text-align:right">
            <button class="btn" onclick="Modules.maintenance.done('${w.id}')">Terminer</button>
            <button class="btn ghost" onclick="Modules.maintenance.del('${w.id}')">Suppr</button>
          </td>
        </tr>
      `);
      v.append(html`
        <table class="table"><thead><tr><th>Bien</th><th>Type</th><th>Statut</th><th></th></tr></thead>
        <tbody>${rows}</tbody></table>
      `);
      setView(v);
    },
    newOrder(){
      const body = html`
      <form class="form" id="f">
        <div class="field"><label>Bien</label>
          <select name="place">${DB.state.properties.map(p=>`<option>${p.ref}</option>`).join('')}</select></div>
        <div class="field"><label>Type</label><input name="type" placeholder="Plomberie, √âlec‚Ä¶"></div>
        <div class="field"><label>Statut</label><select name="status"><option>urgent</option><option>planifi√©</option><option>clos</option></select></div>
      </form>`;
      Modal.open({title:'Nouvel ordre', body, actions:[
        {label:'Annuler', onClick:()=>Modal.close()},
        {label:'Cr√©er', primary:true, onClick:()=>{
          const d=Object.fromEntries(new FormData(body.querySelector('#f')).entries());
          DB.state.maintenance.push({id:uid('m'), ...d}); DB.save(); Modal.close(); router();
        }}
      ]});
    },
    done(id){ const w=DB.state.maintenance.find(x=>x.id===id); if(w){ w.status='clos'; DB.save(); router(); } },
    del(id){ DB.state.maintenance = DB.state.maintenance.filter(x=>x.id!==id); DB.save(); router(); },

    // --- Revenus ---
    revenue(){
      const inc = DB.state.income;
      const tot = DB.state.properties.reduce((a,b)=>a+(+b.rent||0),0);
      const paid = DB.state.payments.filter(p=>p.status==='ok').reduce((a,b)=>a+(+b.amount||0),0);
      const due = Math.max(tot-paid,0);

      const v = html`
        ${setToolbar('Revenus', [
          {label:'Exporter CSV', onClick:()=>download('revenus.csv', csv(DB.state.payments))}
        ])}
        <div class="cards">
          <div class="card"><div class="muted">Mois</div><div class="kpi">${inc.month}</div></div>
          <div class="card"><div class="muted">Loyers th√©oriques</div><div class="kpi">${fmtMoney(tot)}</div></div>
          <div class="card"><div class="muted">Pay√©</div><div class="kpi ok">${fmtMoney(paid)}</div></div>
          <div class="card"><div class="muted">Restant</div><div class="kpi warn">${fmtMoney(due)}</div></div>
        </div>
      `;
      setView(v);
    },

    // --- R√©glages ---
    settings(){
      const s = DB.state.settings;
      const body = html`
      <form class="form" id="f">
        <div class="field"><label>Nom de l‚Äôentreprise</label><input name="company" value="${s.company}"></div>
        <div class="field"><label>Devise</label>
          <select name="currency"><option ${s.currency==='EUR'?'selected':''}>EUR</option><option ${s.currency==='USD'?'selected':''}>USD</option></select>
        </div>
      </form>`;
      const v = document.createElement('div');
      v.append(setToolbar('R√©glages', [
        {label:'Sauvegarder', primary:true, onClick:()=>{
          const d=Object.fromEntries(new FormData(body.querySelector('#f')).entries());
          DB.state.settings = d; DB.save(); router();
        }}
      ]));
      v.append(html`<div class="panel">${body}</div>`);
      setView(v);
    }
  };

  // ---------- View mount ----------
  function setView(node){
    const v = $('#view'); v.innerHTML=''; v.append(node);
    highlightRoute(routeName());
  }

  // ---------- Router ----------
  function routeName(){ return (location.hash.replace('#/','') || 'dashboard').split('?')[0]; }
  function highlightRoute(r){
    $$('#menu a').forEach(a=> a.classList.toggle('active', a.getAttribute('href')==='#/'+r));
  }
  function router(){
    const r = routeName();
    (Modules[r] || Modules.dashboard)();
  }
  window.addEventListener('hashchange', router);
  window.addEventListener('load', router);

  </script>
</body>
</html>

